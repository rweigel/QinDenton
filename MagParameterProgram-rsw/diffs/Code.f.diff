5,9c5,6
< c     By Zhengrui Qin and Richard Denton, 09/01/2007                             c
< c     Original code from                                                         c
< c     http://virbo.org/svn/virbo/qindenton/                                      c
< c           MagParameterProgram-rsw/MagmodelinputONE_corrected.f                 c
< c     LANL updated version, 2015 (fix for more recent compilers in 2017)         c
---
> c                                                                                c
> c     By Zhengrui Qin and Richard Denton, 09/01/2007                             c 
10a8,9
> C      character yesno*3
>       common istart,wst(6)
12,28c11,23
< c      write(*,*)'c    IFORMAT = 1 for one minute data                 c'
< c      write(*,*)'c    IFORMAT = 5 for five minute data                c'
< c      write(*,*)'c    IFORMAT = 60 for hourly data                    c'
< c      write(*,*)'cccccccccccccccccccccccccccccccccccccccccccccccccccccc'
< 
<       character ychar*4,fchar*24,filein*32,dumchar*19
<       real dmy(100)
<       common /years/year0,nyrs
<       common wst(6)
<       integer iyear
< 
<       write (*,*) ' please input cadence, starting year, no of years'
<       read (*,*) iformat,year0,nyrs
<       write (*,111) iformat,year0,year0+nyrs-1
<  111  format (' input: cadence',i4,' min  starting year',f6.0,
<      & ' ending year',f6.0)
< 
---
> C      write(*,*)''
> C      write(*,*)'Please read readme.txt (where to download input files)'
> C      write(*,*)''
> C      write(*,*)'cccccccccccccccccccccccccccccccccccccccccccccccccccccc' 
> C      write(*,*)'c    Please choose the data format of input files    c'
> C      write(*,*)'c    IFORMAT = 1 for one minute data                 c'
> C      write(*,*)'c    IFORMAT = 5 for five minute data                c'
> C      write(*,*)'c    IFORMAT = 60 for hourly data                    c'
> C      write(*,*)'c    Please input IFORMAT:                           c'
> C      write(*,*)'cccccccccccccccccccccccccccccccccccccccccccccccccccccc'
> C 71   read(*,*)iformat
>       READ *, iformat
> c      write(*,*)'IFORMAT =',iformat
30,31c25,26
<        write(*,*)' cadence must be 1 or 5 or 60; run aborted'
<        stop
---
>            write(*,*)'  Input error, please input again.  '
> C           goto 71
33,86c28
<       if (iformat.eq.1.or.iformat.eq.5) then
<        if (year0.lt.1995) then
<         write (*,*)' starting year must be after 1994; run aborted'
<         stop
<        end if
<       end if
<       if (iformat.eq.60) then
<        if (year0.lt.1963) then
<         write (*,*)' starting year must be after 1962; run aborted' 
<         stop
<        end if
<       end if
< c     if (year0+nyrs.gt.2016) then
< c      write (*,*)' last year cannot be after 2015; run aborted'
< c      stop
< c     end if
< 
<       iyear=year0-1
<       write (ychar,'(i4)') iyear
<       fchar=ychar//'/QinDenton_'//ychar//'1231_'
<       filein=fchar//'1min.txt'
<       write (*,*) 'searching ',filein
<       open (unit=1,file=filein,err=20,status='old')       ! search for W1-6 pars in previous file
<       do j=1,200
<        read (1,*,end=20)                                  ! skip header (192 lines)
<       end do
<  90   read (1,*,err=20,end=30) dumchar,(dmy(i),i=1,31),(wst(j),j=1,6)
<        go to 90
<  20   filein=fchar//'5min.txt'
<       write (*,*) 'searching ',filein
<       open (unit=2,file=filein,err=21,status='old')
<       do j=1,200
<        read (2,*,end=21)                  
<       end do
<  91   read (2,*,err=21,end=30) dumchar,(dmy(i),i=1,31),(wst(j),j=1,6)
<        go to 91
<  21   filein=fchar//'hour.txt'
<       write (*,*) 'searching ',filein
<       open (unit=3,file=filein,err=22,status='old')
<       do j=1,200
<        read (3,*,end=22)                  
<       end do
<  92   read (3,*,err=22,end=30) dumchar,(dmy(i),i=1,31),(wst(j),j=1,6)
<        go to 92
<  22   write (*,*) ' did not find previous WG file, will use averages'
<       wst(1) = 0.44    ! at the average values for status 2 in table 3
<       wst(2) = 0.42    ! of Qin,Denton,Tsyganenko,Wolf article
<       wst(3) = 0.66    ! in Space Weather, vol 5, issue 11
<       wst(4) = 0.48    ! http://onlinelibrary.wiley.com/doi/10.1029/2006SW000296/full
<       wst(5) = 0.49   
<       wst(6) = 0.91
< 
<  30   write (*,130) wst(1),wst(2),wst(3),wst(4),wst(5),wst(6)
<  130  format ('  initial Ws :',6f7.3)
---
> C      write(*,*)''
87a30,59
> ccccc Starting options ccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
> C      write(*,*)'cccccccccccccccccccccccccccccccccccccccccccccccccccccc'
> C      write(*,*)'c    W values starting options                       c'                            
> C      write(*,*)'c    1 to start from 0 for all W parameters          c'
> C      write(*,*)'c    2 to start from user specified values           c'
> C      write(*,*)'c      (W values right before the first record       c'
> C      write(*,*)'c       of the file which you are analyzing)         c' 
> C      write(*,*)'c    e.g., for 5 minute data, enter the W parameters c'
> C      write(*,*)'c      for the preceding 5 minute interval           c'
> C      write(*,*)'c    Input the starting option:                      c'
> C      write(*,*)'c         ( 2 is recommended )                       c'
> C      write(*,*)'cccccccccccccccccccccccccccccccccccccccccccccccccccccc'
> C 73   read(*,*)istart
> C      if(istart.ne.1.and.istart.ne.2) then
> C           write(*,*)'  Input error, please input again.  '
> C           goto 73
> C      endif
> C      if(istart.eq.2) then 
> C      write(*,*)'     Type the starting values for all six W parameters'
> C      write(*,*)'     Six number separated by comma or space'
> C      read(*,*)wst(1),wst(2),wst(3),wst(4),wst(5),wst(6) 
> C      endif
> C      write(*,*)''
>       istart = 2
>       wst(1) = 0.
>       wst(2) = 0.
>       wst(3) = 0.
>       wst(4) = 0.
>       wst(5) = 0.
>       wst(6) = 0.
89c61
< 
---
> C      iformat = 60
117,120d88
< cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
< 
< 
< c  *************  FOR 1 MIN DATA ***************************************
124d91
< 
126d92
< 
127a94
>       common istart,wst(6)
131,132d97
<       common wst(6)
<       common /years/year0,nyrs
139,140c104
< 
<  33   write(*,*) finput//' NOT EXIST'
---
>  33   write(*,*)finput//' NOT EXIST'
142d105
< 
153,154d115
<        IF (iyr4.lt.year0.or.iyr4.ge.year0+nyrs) go to 10  ! Alin
< c       IF (iyr4.lt.year0) go to 10  ! Alin
193d153
< 
195d154
< 
198c157
<       common wst(6)
---
>       common istart,wst(6)
277a237,243
> c     this program adds bs**gamma columns
>         subroutine bsgamma_min
>         common istart,wst(6)
>         dimension bsg(6),gamma(6),idmy(7),dummy(24)
>         character finput*30,fout*30
>         real N,V,P
> 	data gamma/0.87,0.67,1.32,1.29,0.69,0.53/
279,286d244
< c     this program adds bs**gamma columns    ! runs 10mins for 20years/data, and 5mins for 1year
<       subroutine bsgamma_min
<       dimension bsg(6),gamma(6),idmy(7),dummy(24)
<       character finput*30,fout*30
<       real N,V,P
<       data gamma/0.87,0.67,1.32,1.29,0.69,0.53/
<       common wst(6)
<       common /years/year0,nyrs
299d256
< 
302c259,260
<        IF (iyr.lt.year0.or.iyr.ge.year0+nyrs) go to 10  ! Alin
---
> 40    format(2I4,4I3,3I4,2I7,F6.2,I7, 8F8.2,4F8.1,F7.2, 
>      $F9.0,F6.2,2F7.2,F6.1,6F8.2) 
307a266
>          
321,322d279
< 40    format(2I4,4I3,3I4,2I7,F6.2,I7, 8F8.2,4F8.1,F7.2, 
<      $F9.0,F6.2,2F7.2,F6.1,6F8.2) 
327,328d283
<  
<  
331,332d285
<       close(1)
<       close(2)
338d290
< 
340d291
< 
342,344c293,295
< 
<       parameter (nipyr=365,nii=30000,nj=11)
<       dimension y(nii),p(nii,nj),w(nii,nj),pv(nj)
---
>       common istart,wst(6)
>       parameter (nipyr=365,nyr=20,ni=nipyr*nyr, nj=11)
>       dimension y(ni),p(ni,nj),w(ni,nj),pv(nj)
348,349c299
<       common wst(6)
<       common /years/year0,nyrs
---
>            
351,352c301,302
<       ni=nipyr*nyrs
<       iy1= nint(year0)
---
>       y1= 1995.
>       iy1= nint(y1)
429d378
< 
431d379
< 
433,434c381,382
< 
<       parameter (nk=12)     
---
>       common istart,wst(6)
>       parameter (ni=365*20,nk=12)     
436c384
<       dimension av1(nk,36500),gamma(6)
---
>       dimension av1(nk,ni),gamma(6)
438,439c386,389
<       common wst(6)
<       common /years/year0,nyrs
---
>      
> cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
>       
>      
441d390
<       ni=365*nyrs
445c394,397
< cccc  input the 1 day average
---
>       
> 
> ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc	
> ccccccc  input the 1 day average
447,448c399,401
<       do i=1,ni
<       read(1,*,end=35) (av1(j,i),j=1,nk)
---
>       
>       do i=1,365*20
>       read(1,*,end=35) (av1(j,i),j=1,12)
453c406
<         do  k=2,nk
---
>         do  k=2,12
477c430
<          do k=7,nk
---
>          do k=7,12
495d447
< 
497d448
< 
499,500c450,451
< 
<       parameter(nc=11,nd=386,nmax=12999999)            ! nd not used, nmax < 13,100,000
---
>       common istart,wst(6)
>       parameter(nc=11,nd=386)
503,504c454,455
<       double precision tyear,datamin(nc+1,nmax)
<       dimension idmy(7),dummy(24),correltime(nc),itime(4,nmax)
---
>       double precision tyear,datamin(nc+1,9999999)
>       dimension idmy(7),dummy(24),correltime(nc),itime(4,9999999)
508,509c459,460
<       common wst(6)
<       common /years/year0,nyrs
---
> cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
>  
511c462
<       finput1='1min/interav1day.d'
---
> 
512a464
>       finput1='1min/interav1day.d'
516c468,469
< cccc  input the 1 day average ccccccccccccccccccccccccccccccccccccccccccccccccccccccc
---
> cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
> cccccccc  input the 1 day average ccccccccccccccccccccccccccccccccccccccccccccccccccccccc
517a471
>      
522d475
< 
524c477
< 
---
> ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc	
528,530c481,482
< 
<       do j=1,nmax
< 444   read(2,40,err=20,end=20) iyr4,idoy,ihr,imin,(idmy(i),i=1,7),d,ii
---
>       do j=1,9999999
>       read(2,40,err=20,end=20) iyr4,idoy,ihr,imin,(idmy(i),i=1,7),d,ii
532c484,485
<       IF (iyr4.lt.year0.or.iyr4.ge.year0+nyrs) go to 444  ! Alin
---
> 40    format(2I4,4I3,3I4,2I7,F6.2,I7, 8F8.2,4F8.1,F7.2,
>      $F9.0,F6.2,2F7.2,F6.1,6F8.2)
553,555d505
< 40    format(2I4,4I3,3I4,2I7,F6.2,I7, 8F8.2,4F8.1,F7.2,
<      $F9.0,F6.2,2F7.2,F6.1,6F8.2)
< 
594,602d543
<       i00=0
< 
<       DO 2002 j=1,ni
< 
< cw       if (itime(1,j).gt.i00.and.nyrs.gt.1)
< cw     &   write (*,*) ' year',itime(1,j),' started'
< cw       i00=itime(1,j)
< 
<        do 4000 k=2,12
603a545,546
>       do 2002 j=1,ni
>         do 4000 k=2,12
732,734c675
< 
< 2002  Continue
< 
---
> 2002	continue					
738d678
< 
741d680
< 
754d692
< cccccccccccccccccc subroutine WG_min  ccccccccccccccccccccccccccccccccccccc
755a694
> cccccccccccccccccc subroutine WG_min  ccccccccccccccccccccccccccccccccccccc
758c697
<       common wst(6)
---
>       common istart,wst(6)
769,770c708
<       character finput1*30,finput2*30,fout*30,foutput*28
<       character datechar*10,timechar*8,ychar*4,mchar*2,dchar*2
---
>       character finput1*30,finput2*30,fout*30
772,775c710,718
<       do i=1,6
<          W(i)=wst(i)/f(i)
<          Wf(i)=0.0
<       enddo
---
>       if(istart.eq.1) then
>           do i=1,6
>              W(i)=0.0
>           enddo
>       else
>           do i=1,6
>              W(i)=wst(i)/f(i)
>           enddo
>       endif  
780a724,727
>       do i=1,6
>          Wf(i)=0.0
>       enddo
>      
787,792c734,741
< c      open(unit=3,file=fout,status='unknown')
< c      write(3,52) 'Year','Day','Hr','Min','ByIMF','BzIMF','V_SW',
< c     $'Den_P','Pdyn','G1','G2','G3','8 status','kp','akp3','dst'
< c     $,'Bz1','Bz2','Bz3','Bz4','Bz5','Bz6','W1'
< c     $,'W2','W3','W4','W5','W6','6 stat'
< c52    format(a5,a4,a3,a4,a6,7a7,a10,2a7,a6,6a7,6a9,a8)
---
>       open(unit=3,file=fout,status='unknown')
>       
>       write(3,52) 'Year','Day','Hr','Min','ByIMF','BzIMF','V_SW',
>      $'Den_P','Pdyn','G1','G2','G3','8 status','kp','akp3',
>      $  'dst'
>      $,'Bz1','Bz2','Bz3','Bz4','Bz5','Bz6','W1'
>      $,'W2','W3','W4','W5','W6','6 stat'
> 52    format(a5,a4,a3,a4,a6,7a7,a10,2a7,a6,6a7,6a9,a8)
797d745
<       idayold=0
802d749
<        if (iyr1.ne.iyr) write (*,*) 'year mismatch in WGmin input'
804,814d750
< 
<       call daymonth(iyr,idy,jmo,iday)
<       call utc(iyr,jmo,iday,ihr,imn,datechar,timechar,mchar,dchar)
<       if (idy.ne.idayold) then
<        if (idayold.ne.0) close(3)
<        idayold=idy
<        write (ychar,'(i4)') iyr
<        foutput=ychar//'/QinDenton_'//ychar//mchar//dchar//'_1min'
<        open(unit=3,file=foutput,status='unknown')
<       end if
< 
816c752
< 
---
>     
922,945c858,866
< 
< c      if(idy1.eq.idy.and.ihr1.eq.ihr.and.imn1.eq.imn) then
< c         write(3,50)iyr,idy,ihr,imn,by,bz,v,den,p,G1,G2,G3,
< c     $iby,ibz,iv,id,ip,iG1,iG2,iG3,kp,kp3,dst,(bzn(i),i=1,6),
< c     $(W(i)*f(i),i=1,6),(iW(i),i=1,6)
< c50    format(I5,I4,2I3,2f7.2,f7.1,2f7.2,3f7.2,i3,7i1,
< c     $f7.2,f7.2,i6,6f7.2,6f9.3,i3,5i1)
< c      endif
<       
<       If (idy1.eq.idy.and.ihr1.eq.ihr.and.imn1.eq.imn) then
< c       if (dst.ne.99999) 
<        write (3,500)
<      &  datechar,timechar,iyr,jmo,iday,ihr,imn,
<      &  by,bz,v,den,p,G1,G2,G3,
<      &  iby,ibz,iv,id,ip,iG1,iG2,iG3,
<      &  kp,kp3,dst,(bzn(i),i=1,6),(W(i)*f(i),i=1,6),(iW(i),i=1,6)
<       End If
< 500    format(a10,'T',a8,i5,x,4i3,' 00',x,
<      &  2f7.2,f7.1,x,2f7.2,x,3f7.2,x,
<      &  8i2,x,
<      &  2f6.2,i6,x,6f7.2,x,6f7.3,x,6i2)
< 
<       Go To 10
< 
---
>       if(idy1.eq.idy.and.ihr1.eq.ihr.and.imn1.eq.imn) then
>          write(3,50)iyr,idy,ihr,imn,by,bz,v,den,p,G1,G2,G3,
>      $iby,ibz,iv,id,ip,iG1,iG2,iG3,kp,kp3,dst,(bzn(i),i=1,6),
>      $(W(i)*f(i),i=1,6),(iW(i),i=1,6)
> 50    format(I5,I4,2I3,2f7.2,f7.1,2f7.2,3f7.2,i3,7i1,
>      $f7.2,f7.2,i6,6f7.2,6f9.3,i3,5i1)
>       endif
>       
>       goto 10
950d870
< 
954,957d873
< 
< c  **********  FOR 5 MIN DATA ********************
< 
< 
959d874
< 
961d875
<      
962a877
>       common istart,wst(6)
966,967c881
<       common wst(6)
<       common /years/year0,nyrs
---
>      
969c883
<       finput='5min/kpdst.lst'              ! Kp, Dst data from 1995 to 2015
---
>       finput='5min/kpdst.lst' 
986d899
<        IF (iyr4.lt.year0) go to 10          ! Alin: load data starting at year0
1025d937
< 
1027d938
< 
1030c941
<       common wst(6)
---
>       common istart,wst(6)
1105d1015
< 
1107d1016
< 
1110c1019
<         common wst(6)
---
>         common istart,wst(6)
1117c1026
<       finput='5min/omni_5min.asc'              ! OMNI data from 1981 to 2015
---
>       finput='5min/omni_5min.asc' 
1151,1152d1059
<       close(1) 
<       close(2) 
1157d1063
< 
1159d1064
< 
1161d1065
< 
1163,1165c1067,1069
< 
<       parameter (nipyr=365,nii=30000,nj=11)      
<       dimension y(nii),p(nii,nj),w(nii,nj),pv(nj)
---
>       common istart,wst(6)
>       parameter (nipyr=365,nyr=20,ni=nipyr*nyr, nj=11)
>       dimension y(ni),p(ni,nj),w(ni,nj),pv(nj)
1169,1170d1072
<       common /years/year0,nyrs
<       common wst(6)
1172,1174c1074,1076
<       ni=nipyr*nyrs
<       iy1= nint(year0)              ! was 1995, the 1min data over more than 20 years exceeds RAM 
<       dyr= 1./nipyr                   !    also kpdst.lst starts 1995
---
>       y1= 1995.
>       iy1= nint(y1)
>       dyr= 1./nipyr
1187d1088
< 
1189d1089
< 
1193,1197c1093,1098
<       if( mod(iyr4,4).eq.0 ) then
<          doytot= 366.
<       else
<          doytot= 365.
<       endif
---
>          if( mod(iyr4,4).eq.0 ) then
>             doytot= 366.
>          else
>             doytot= 365.
>          endif
>          iyr4m= iyr4 - iy1
1199,1222c1100,1106
<       iyr4m= iyr4 - iy1                                        ! can be negative
<       yv= iyr4m + ( idoy -1. + (ihr + imin/60.0)/24. )/doytot
<       rii= (yv-y(1))/dyr + 1.                                  ! can be negative
<       ii= rii                                                  ! integer(rii)
<       ip= ii + 1           
<       fip= rii - ii
<       fii= 1. - fip
< 
<       do 23008 j= 1,nj
<         if( (j.eq.1 .or. j.eq.2).and. pv(j).eq.9999.99 ) go to 23008
<           if( j.eq.3 .and. pv(j).eq.99999.9 ) go to 23008
<           if( j.eq.4 .and. pv(j).eq.999.99 ) go to 23008
<           if( j.eq.5 .and. pv(j).eq.99.99 ) go to 23008
<           if( j.ge.6 .and. pv(j).eq.9999.99) go to 23008
<           if( ii.ge.1 .and. ii.le.ni ) then     ! retains data only between year0 and year0+nyrs
<              p(ii,j)= p(ii,j) + fii*pv(j)
<              w(ii,j)= w(ii,j) + fii
<           endif
<           if( ip.ge.1 .and. ip.le.ni ) then
<              p(ip,j)= p(ip,j) + fip*pv(j)
<              w(ip,j)= w(ip,j) + fip
<           endif
< 23008 continue
<       go to 34
---
>          yv= iyr4m + ( idoy -1. + (ihr + imin/60.0)/24. )/doytot
> 
>          rii= (yv-y(1))/dyr + 1.
>          ii= rii
>          ip= ii + 1
>          fip= rii - ii
>          fii= 1. - fip
1224c1108,1125
< 300   close(11,status='delete')
---
>          do 23008 j= 1,nj
> 
>          if( (j.eq.1 .or. j.eq.2).and. pv(j).eq.9999.99 ) go to 23008
>             if( j.eq.3 .and. pv(j).eq.99999.9 ) go to 23008
>             if( j.eq.4 .and. pv(j).eq.999.99 ) go to 23008
>             if( j.eq.5 .and. pv(j).eq.99.99 ) go to 23008
>             if( j.ge.6 .and. pv(j).eq.9999.99) go to 23008
>             if( ii.ge.1 .and. ii.le.ni ) then
>                p(ii,j)= p(ii,j) + fii*pv(j)
>                w(ii,j)= w(ii,j) + fii
>             endif
>             if( ip.ge.1 .and. ip.le.ni ) then
>                p(ip,j)= p(ip,j) + fip*pv(j)
>                w(ip,j)= w(ip,j) + fip
>             endif
> 23008    continue
> 
>       go to 34
1225a1127
>   300 close(11,status='delete')
1235d1136
< 
1237,1240c1138,1141
<       do 23014 i= 1,ni                                 ! output at year0-(year0+nyrs)
<          yrdouble=y(i)+iy1
<          write(21,2100) yrdouble,(p(i,j),j=1,nj)
<  2100    format(f9.4,11(1x,f9.4))
---
>       do 23014 i= 1,ni
> 	   yrdouble=y(i)+iy1
>           write(21,2100) yrdouble,(p(i,j),j=1,nj)
>  2100       format(f9.4,11(1x,f9.4))
1243c1144
< 
---
>  1000 continue 
1245d1145
< 
1249d1148
< 
1251d1149
< 
1253d1150
< 
1255,1256c1152,1153
< 
<       parameter (nk=12)                   
---
>       common istart,wst(6)
>       parameter (ni=365*20,nk=12)
1258c1155
<       dimension av1(nk,36500),gamma(6)
---
>       dimension av1(nk,ni),gamma(6)
1260,1261d1156
<       common /years/year0,nyrs
<       common wst(6)
1263c1158
<       ni=365*nyrs
---
> cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc   
1266a1162
> ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc	
1269,1270c1165,1166
<       do i=1,ni
<        read(1,*,end=35) (av1(j,i),j=1,nk)        ! loads data at year0-(year0+nyrs)
---
>       do i=1,365*20
>       read(1,*,end=35) (av1(j,i),j=1,12)
1275c1171
<         do  k=2,nk
---
>         do  k=2,12
1299c1195
<          do k=7,nk
---
>          do k=7,12
1306c1202
<          write(2,2100) (av1(j,i),j=1,nk)     ! output at year0-(year0+nyrs)
---
>          write(2,2100) (av1(j,i),j=1,nk)
1312d1207
< 
1316d1210
< 
1318,1320c1212
< 
< c    This program  interpolates across the gaps in the 5-minute data     
< 
---
> c    This program  interpolates across the gaps in the one-minute data     
1322,1323c1214,1215
< 
<       parameter(nc=11,nmax=5000000)                       ! 105192*nyrs < nmax < 8e6
---
>       common istart,wst(6)
>       parameter(nc=11)
1326,1327c1218,1219
<       double precision tyear,data5min(nc+1,nmax) 
<       dimension idmy(7),dummy(24),correltime(nc),itime(4,nmax)
---
>       double precision tyear,data5min(nc+1,2500000)
>       dimension idmy(7),dummy(24),correltime(nc),itime(4,2500000)
1331,1334c1223
<       common wst(6)
<       common /years/year0,nyrs
< 
<       finput1='5min/interav1day5min.d'   
---
> cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
1335a1225
>       finput1='5min/interav1day5min.d'
1338d1227
< 
1342c1231
<       read(1,*,end=34)(av1(j,i),j=1,12)    ! loads data at year0-(year0+nyrs)
---
>       read(1,*,end=34)(av1(j,i),j=1,12)
1346a1236
> ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc	
1350,1352c1240,1241
< 
<       do i=1,nmax
< 555   read(2,40,err=20,end=20) iyr4,idoy,ihr,imin,aa,By,Bz,aa,
---
>       do i=1,9999999
>       read(2,40,err=20,end=20) iyr4,idoy,ihr,imin,aa,By,Bz,aa,
1354c1243
<        IF (iyr4.lt.year0.or.iyr4.ge.year0+nyrs) go to 555  ! Alin: load data  at year0-(year0+nyrs)
---
> 40    format(2I4,2I3,a77,2f8.2,a16,f8.1,a24,f7.2,a9,f6.2,a68)
1364c1253
<          data5min(4,n)=V   !v 
---
>          data5min(4,n)=V  !v 
1366c1255
<          data5min(6,n)=P   !pdyn
---
>          data5min(6,n)=P !pdyn
1375d1263
< 40    format(2I4,2I3,a77,2f8.2,a16,f8.1,a24,f7.2,a9,f6.2,a68)
1412,1420d1299
<       i00=0
< 
<       DO 2002 j=1,ni
< 
< cw       if (itime(1,j).gt.i00.and.nyrs.gt.1)
< cw     &    write (*,*) ' year',itime(1,j),' started'
<        i00=itime(1,j)
< 
<        do 4000 k=2,12
1421a1301,1302
>       do 2002 j=1,ni
>         do 4000 k=2,12
1423d1303
< 
1439a1320
> 
1443a1325
>                       
1445c1327
<               DO WHILE (data5min(k,i1(n)) .eq. 9999.99)
---
>        	      DO WHILE (data5min(k,i1(n)) .eq. 9999.99)
1451a1334
>          
1459a1343
>      
1467a1352
>     
1476c1361
<         endif  
---
> 	 endif  
1494c1379
<                 ainter(n)=data5min(k,i2(n))
---
> 	        ainter(n)=data5min(k,i2(n))
1502c1387
<               if((i2(n)-j) .lt. ii) ainter(n)=data5min(k,i2(n))
---
>        	      if((i2(n)-j) .lt. ii) ainter(n)=data5min(k,i2(n))
1504c1389
<               if((j-i1(n)) .ge. ii .and. (i2(n)-j) .ge. ii) then
---
>        	      if((j-i1(n)) .ge. ii .and. (i2(n)-j) .ge. ii) then
1507c1392
<                  wav=1-w1-w2
---
>     	         wav=1-w1-w2
1509c1394
<                  if(data5min(1,j).lt. av1(1,1)) fav=av1(k,1)
---
> 	         if(data5min(1,j).lt. av1(1,1)) fav=av1(k,1)
1518c1403
<                  enddo                 
---
>                  enddo	                  
1533c1418
<           
---
> 	          
1544,1546c1429
< 
< 2002  Continue
< 
---
> 2002  continue					
1550d1432
< 
1552,1553d1433
< 
< 
1555,1556d1434
< ccc  Alin: Calculation of W pars is recursive, all but W3 converge quickly
< 
1559c1437
<       common wst(6)
---
>       common istart,wst(6)
1570,1571c1448
<       character finput1*30,finput2*30,fout*30,foutput*28
<       character datechar*10,timechar*8,ychar*4,mchar*2,dchar*2
---
>       character finput1*30,finput2*30,fout*30
1573,1576c1450,1458
<       do i=1,6
<         W(i)=wst(i)/f(i)
<         Wf(i)=0.0
<       enddo
---
>       if(istart.eq.1) then          
>           do i=1,6
>              W(i)=0.0
>           enddo
>       else
>           do i=1,6
>              W(i)=wst(i)/f(i)
>           enddo
>       endif  
1581a1464,1468
>       do i=1,6
>          Wf(i)=0.0
>       enddo
> 
>       
1588,1594c1475,1482
< c      open(unit=3,file=fout,status='unknown')
< c      write(3,52) 'Year','Day','Hr','Min','ByIMF','BzIMF','V_SW',
< c     $'Den_P','Pdyn','G1','G2','G3','8 status','kp','akp3','dst',
< c     $'Bz1','Bz2','Bz3','Bz4','Bz5','Bz6',
< c     $'W1','W2','W3','W4','W5','W6','6 stat'
< c52    format(a5,a4,a3,a4,a6,7a7,a10,2a7,a6,6a7,6a9,a8)
< 
---
>       open(unit=3,file=fout,status='unknown')
>       write(3,52) 'Year','Day','Hr','Min','ByIMF','BzIMF','V_SW',
>      $'Den_P','Pdyn','G1','G2','G3','8 status','kp','akp3',
>      $  'dst'
>      $,'Bz1','Bz2','Bz3','Bz4','Bz5','Bz6','W1'
>      $,'W2','W3','W4','W5','W6','6 stat'
> 52    format(a5,a4,a3,a4,a6,7a7,a10,2a7,a6,6a7,6a9,a8)
>      
1598d1485
<       idayold=0
1603,1604d1489
<        if (iyr1.ne.iyr) write (*,*) 'year mismatch in WG_5min input',
<      & iyr1, iyr
1606,1616d1490
<  
<       call daymonth(iyr,idy,jmo,iday)
<       call utc(iyr,jmo,iday,ihr,imn,datechar,timechar,mchar,dchar)
<       if (idy.ne.idayold) then
<        if (idayold.ne.0) close(3)
<        idayold=idy
<        write (ychar,'(i4)') iyr
<        foutput=ychar//'/QinDenton_'//ychar//mchar//dchar//'_5min'
<        open(unit=3,file=foutput,status='unknown')
<       end if
< 
1618d1491
< 
1706c1579
<          W(i)=r(i)/12.0*S(i)+W(i)*exp(-r(i)/12.0)            ! previous W(i) are used !!!!
---
>          W(i)=r(i)/12.0*S(i)+W(i)*exp(-r(i)/12.0)
1723,1746c1596,1602
< c Alin: matching of years in input files was not inforced (is now), 
< c resulting in combining KpDst data starting 1995 with OMNI W/G parameters starting 1981
< c day-tag mismatch of leap and non-leap years entries led to some years being skipped 
< 
< c      if(idy1.eq.idy.and.ihr1.eq.ihr.and.imn1.eq.imn) then
< c         write(3,50)iyr,idy,ihr,imn,by,bz,v,den,p,G1,G2,G3,
< c     $iby,ibz,iv,id,ip,iG1,iG2,iG3,kp,kp3,dst,(bzn(i),i=1,6),
< c     $(W(i)*f(i),i=1,6),(iW(i),i=1,6)
< c50    format(I5,I4,2I3,2f7.2,f7.1,2f7.2,3f7.2,i3,7i1,
< c     $f7.2,f7.2,i6,6f7.2,6f9.3,i3,5i1)
< c      endif
< 
<       If (idy1.eq.idy.and.ihr1.eq.ihr.and.imn1.eq.imn) then
< c       if (dst.ne.99999) 
<        write (3,500)
<      &  datechar,timechar,iyr,jmo,iday,ihr,imn,            
<      &  by,bz,v,den,p,G1,G2,G3,
<      &  iby,ibz,iv,id,ip,iG1,iG2,iG3,
<      &  kp,kp3,dst,(bzn(i),i=1,6),(W(i)*f(i),i=1,6),(iW(i),i=1,6)
<       End If
< 500    format(a10,'T',a8,i5,x,4i3,' 00',x,                
<      &  2f7.2,f7.1,x,2f7.2,x,3f7.2,x,
<      &  8i2,x,
<      &  2f6.2,i6,x,6f7.2,x,6f7.3,x,6i2)
---
>       if(idy1.eq.idy.and.ihr1.eq.ihr.and.imn1.eq.imn) then
>          write(3,50)iyr,idy,ihr,imn,by,bz,v,den,p,G1,G2,G3,
>      $iby,ibz,iv,id,ip,iG1,iG2,iG3,kp,kp3,dst,(bzn(i),i=1,6),
>      $(W(i)*f(i),i=1,6),(iW(i),i=1,6)
> 50    format(I5,I4,2I3,2f7.2,f7.1,2f7.2,3f7.2,i3,7i1,
>      $f7.2,f7.2,i6,6f7.2,6f9.3,i3,5i1)
>       endif
1748,1749c1604
<       Go To 10
< 
---
>       goto 10
1756,1828d1610
< 
<       Subroutine daymonth(iyear,idy,jmo,iday)
< 
<       integer jdm(12)
<       data jdm/31,28,31,30,31,30,31,31,30,31,30,31/
< 
<       jdm(2)=28
<       if (mod(iyear,4).eq.0) jdm(2)=29
<       iday=idy
<       j=0
<  10   j=j+1
<       if (iday.le.jdm(j)) then
<        jmo=j
<       else
<        iday=iday-jdm(j)
<        go to 10
<       end if
< 
<       return
<       End
< cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
< 
<       Subroutine utc(iyr,jmo,iday,ihr,imn,datechar,timechar,mo,dy)
< 
<       character datechar*10,timechar*8
<       character year*4,m*1,mo*2,d*1,dy*2,h*1,hr*2,n*1,nm*2
< 
<       write (year,'(i4)') iyr
< 
<       if (jmo.lt.10) then
<         write (m,'(i1)') jmo
<         mo='0'//m
<        else
<         write (mo,'(i2)') jmo
<        end if
< 
<        if (iday.lt.10) then
<         write (d,'(i1)') iday
<         dy='0'//d
<        else
<         write (dy,'(i2)') iday
<        end if
< 
<        if (ihr.lt.10) then
<         write (h,'(i1)') ihr
<         hr='0'//h
<        else
<         write (hr,'(i2)') ihr
<        end if
< 
<        if (imn.lt.10) then
<         write (n,'(i1)') imn
<         nm='0'//n
<        else
<         write (nm,'(i2)') imn
<        end if
< 
<        datechar=year//'-'//mo//'-'//dy
<        timechar=hr//':'//nm//':00'
< 
<       return
<       End
< 
< 
< cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
< 
< 
< c     ******   FOR 1 HOUR DATA  ********
< 
< 
< ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
< 
< 
1830d1611
< 
1831a1613
>       common istart,wst(6)
1838,1839d1619
<       common wst(6)
<       common /years/year0,nyrs
1862d1641
<        IF (iyr4.lt.year0.or.iyr4.ge.year0+nyrs) go to 10  ! Alin
1868d1646
< 
1920d1697
< 
1922d1698
< 
1924d1699
< 
1926,1927c1701,1703
<       parameter (nipyr=1,nii=1000, nj=11)
<       dimension y(nii),p(nii,nj),w(nii,nj),pv(nj)
---
>       common istart,wst(6)
>       parameter (nipyr=1,nyr=50,ni=nipyr*nyr, nj=11)
>       dimension y(ni),p(ni,nj),w(ni,nj),pv(nj)
1931,1932c1707
<       common wst(6)
<       common /years/year0,nyrs
---
>            
1934,1935c1709,1710
<       ni=nipyr*nyrs
<       iy1=nint(year0)                       ! was 1963
---
>       y1=1963.
>       iy1=nint(y1)
2011d1785
< 
2013d1786
< 
2015d1787
< 
2017,2018c1789,1791
<       parameter (nipyr=18,nii=10000,nj=11)
<       dimension y(nii),p(nii,nj),w(nii,nj),pv(nj)
---
>       common istart,wst(6)
>       parameter (nipyr=18,nyr=50,ni=nipyr*nyr, nj=11)
>       dimension y(ni),p(ni,nj),w(ni,nj),pv(nj)
2022,2023c1795
<       common wst(6)
<       common /years/year0,nyrs
---
>            
2025,2026c1797,1798
<       ni=nipyr*nyrs
<       iy1=nint(year0)                ! was 1963
---
>       y1=1963.
>       iy1=nint(y1)
2101d1872
< 
2103d1873
< 
2106d1875
< 
2108c1877
<       common wst(6)
---
>       common istart,wst(6)
2119a1889
>       
2124a1895
> cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
2126d1896
< 
2133a1904
> ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc	
2264d2034
< 
2266d2035
< 
2268d2036
< 
2270c2038
<       common wst(6)
---
>       common istart,wst(6)
2280a2049
> cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc
2281a2051
>     
2287d2056
< cccccccc  input the 20 days average ccccccccccccccccccccccccccccccccccccccccccccccccccccccc
2288a2058
> cccccccc  input the 20 days average ccccccccccccccccccccccccccccccccccccccccccccccccccccccc
2295,2296c2065,2066
<       nd=i-1  
< 
---
>       nd=i-1
> ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc	
2326,2327c2096
< 
<       nm=n-1
---
>       nm=n
2365d2133
< 
2367d2134
< 
2437a2205
> 
2509,2511c2277
< 
< 2002  Continue
< 
---
> 2002	continue					
2516,2517c2282
< cccccccccccccc end of interhour  ccccccccccccccccccccccccccccccccccccccccccccccccccccc
< 
---
> cccccccccccccc end of intehour  ccccccccccccccccccccccccccccccccccccccccccccccccccccc
2520d2284
< 
2522d2285
< 
2524c2287
<       common wst(6)
---
>       common istart,wst(6)
2530c2293,2294
<       data f/1.069748,1.024995,1.247411,1.100432,0.9768723,1.134791/   
---
>       data f/1.069748,1.024995,1.247411,1.100432,0.9768723,
>      $1.134791/   
2535,2536c2299
<       character finput*30,fout*30,aa,foutput*28
<       character datechar*10,timechar*8,ychar*4,mchar*2,dchar*2
---
>       character finput*30,fout*30,aa
2538,2541c2301,2311
<       do i=1,6
<         W(i)=wst(i)/f(i)
<         Wf(i)=0.0
<       enddo
---
>       
>       
>       if(istart.eq.1) then
>           do i=1,6
>              W(i)=0.0
>           enddo
>       else
>           do i=1,6
>              W(i)=wst(i)/f(i)
>           enddo
>       endif  
2545a2316,2321
>       
>       do i=1,6
>          Wf(i)=0.0
>       enddo
> 
> 
2550,2555c2326,2332
< c      open(unit=3,file=fout,status='unknown')
< c      write(3,52) 'Year','Day','Hr','ByIMF','BzIMF','V_SW',
< c     $'Den_P','Pdyn','G1','G2','G3','8 status','kp','akp3','dst'
< c     $,'Bz1','Bz2','Bz3','Bz4','Bz5','Bz6','W1'
< c     $,'W2','W3','W4','W5','W6','6 stat'
< c52    format(a5,a4,a3,a7,7a7,a10,2a7,a6,6a7,6a9,a8)
---
>       open(unit=3,file=fout,status='unknown')
>       write(3,52) 'Year','Day','Hr','ByIMF','BzIMF','V_SW',
>      $'Den_P','Pdyn','G1','G2','G3','8 status','kp','akp3',
>      $  'dst'
>      $,'Bz1','Bz2','Bz3','Bz4','Bz5','Bz6','W1'
>      $,'W2','W3','W4','W5','W6','6 stat'
> 52    format(a5,a4,a3,a7,7a7,a10,2a7,a6,6a7,6a9,a8)
2560,2561d2336
<       idayold=0
<       imn=0
2567,2577d2341
< 
<       call daymonth(iyr,idy,jmo,iday)
<       call utc(iyr,jmo,iday,ihr,imn,datechar,timechar,mchar,dchar)
<       if (idy.ne.idayold) then
<        if (idayold.ne.0) close(3)
<        idayold=idy
<        write (ychar,'(i4)') iyr
<        foutput=ychar//'/QinDenton_'//ychar//mchar//dchar//'_hour'
<        open(unit=3,file=foutput,status='unknown')
<       end if
< 
2601d2364
< 
2689,2704c2452,2456
< c         write(3,50)iyr,idy,ihr,by,bz,v,den,p,G1,G2,G3,
< c     $iby,ibz,iv,id,ip,iG1,iG2,iG3,kp,kp3,dst,(bznb(i),i=1,6),
< c     $(W(i)*f(i),i=1,6),(iW(i),i=1,6)
< c50    format(I5,I4,I3,2f7.2,f7.1,2f7.2,3f7.2,i3,7i1,
< c     $f7.2,f7.2,i6,6f7.2,6f9.3,i3,5i1)
<  
< cx       if (dst.ne.99999) 
<         write (3,500)
<      &  datechar,timechar,iyr,jmo,iday,ihr,imn,
<      &  by,bz,v,den,p,G1,G2,G3,
<      &  iby,ibz,iv,id,ip,iG1,iG2,iG3,
<      &  kp,kp3,dst,(bznb(i),i=1,6),(W(i)*f(i),i=1,6),(iW(i),i=1,6)
< 500    format(a10,'T',a8,i5,x,4i3,' 00',x,
<      &  2f7.2,f7.1,x,2f7.2,x,3f7.2,x,
<      &  8i2,x,
<      &  2f6.2,i6,x,6f7.2,x,6f7.3,x,6i2)
---
>          write(3,50)iyr,idy,ihr,by,bz,v,den,p,G1,G2,G3,
>      $iby,ibz,iv,id,ip,iG1,iG2,iG3,kp,kp3,dst,(bznb(i),i=1,6),
>      $(W(i)*f(i),i=1,6),(iW(i),i=1,6)
> 50    format(I5,I4,I3,2f7.2,f7.1,2f7.2,3f7.2,i3,7i1,
>      $f7.2,f7.2,i6,6f7.2,6f9.3,i3,5i1)
2706,2707c2458,2459
<       Go to 10
< 
---
>       
>       goto 10
